<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Vulnerability Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #1a1a1a;
            --bg-card: #2d2d2d;
            --text-primary: #f8f9fa;
            --text-secondary: #adb5bd;
            
            /* Severity colors */
            --severity-none: #28a745;       /* Green - No issues */
            --severity-low: #17a2b8;        /* Blue - Minor issues */
            --severity-medium: #ffc107;     /* Yellow - Medium issues */
            --severity-high: #fd7e14;       /* Orange - High severity */
            --severity-critical: #dc3545;   /* Red - Critical issues */
            --severity-untested: #6c757d;   /* Gray - Not tested */
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .endpoint-card {
            transition: all 0.3s ease;
            border: none;
            background-color: var(--bg-card);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        /* Severity indicator strip */
        .endpoint-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background-color: var(--severity-untested);
        }

        /* Severity level classes */
        .endpoint-card.severity-none::before { background-color: var(--severity-none); }
        .endpoint-card.severity-low::before { background-color: var(--severity-low); }
        .endpoint-card.severity-medium::before { background-color: var(--severity-medium); }
        .endpoint-card.severity-high::before { background-color: var(--severity-high); }
        .endpoint-card.severity-critical::before { background-color: var(--severity-critical); }
        .endpoint-card.severity-untested::before { background-color: var(--severity-untested); }

        /* Full card background variants */
        .endpoint-card.severity-none { background-color: rgba(40, 167, 69, 0.1); }
        .endpoint-card.severity-low { background-color: rgba(23, 162, 184, 0.1); }
        .endpoint-card.severity-medium { background-color: rgba(255, 193, 7, 0.1); }
        .endpoint-card.severity-high { background-color: rgba(253, 126, 20, 0.1); }
        .endpoint-card.severity-critical { background-color: rgba(220, 53, 69, 0.1); }
        .endpoint-card.severity-untested { background-color: rgba(108, 117, 125, 0.1); }

        .endpoint-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }

        .severity-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
        }

        .severity-icon {
            font-size: 1.2rem;
        }

        .severity-none .severity-icon { color: var(--severity-none); }
        .severity-low .severity-icon { color: var(--severity-low); }
        .severity-medium .severity-icon { color: var(--severity-medium); }
        .severity-high .severity-icon { color: var(--severity-high); }
        .severity-critical .severity-icon { color: var(--severity-critical); }
        .severity-untested .severity-icon { color: var(--severity-untested); }

        .vuln-status {
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .schema-info {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 12px;
            margin-top: 1rem;
        }

        .test-controls {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .checkbox-group {
            display: flex;
            column-count: 2;
            column-gap: 2rem;
        }

        .form-check-input:checked {
            background-color: #0dcaf0;
            border-color: #0dcaf0;
        }

        .method-badge {
            font-family: 'Fira Code', monospace;
            font-weight: 600;
            padding: 0.25em 0.5em;
        }

        .method-GET { background-color: #28a745; }
        .method-POST { background-color: #007bff; }
        .method-PUT { background-color: #fd7e14; }
        .method-DELETE { background-color: #dc3545; }
        .method-PATCH { background-color: #6f42c1; }

        /* Details panel styles */
        .details-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 40%;
            height: 100vh;
            background-color: var(--bg-card);
            z-index: 1050;
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.3s ease-out;
            padding: 2rem;
            box-shadow: -5px 0 15px rgba(0,0,0,0.3);
        }

        .details-panel.show {
            transform: translateX(0);
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1040;
            display: none;
        }

        .vulnerability-item {
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            background-color: rgba(255,255,255,0.05);
        }

        .vulnerability-critical {
            border-left: 4px solid var(--severity-critical);
        }

        .vulnerability-high {
            border-left: 4px solid var(--severity-high);
        }

        .vulnerability-medium {
            border-left: 4px solid var(--severity-medium);
        }

        .vulnerability-low {
            border-left: 4px solid var(--severity-low);
        }

        .loading-spinner {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .severity-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .severity-critical {
            background-color: var(--severity-critical);
        }

        .severity-high {
            background-color: var(--severity-high);
        }

        .severity-medium {
            background-color: var(--severity-medium);
        }

        .severity-low {
            background-color: var(--severity-low);
        }
        .card-body{
            background-color:var(--bg-card)
        }
        /* Add to existing styles */
.findings-table {
    background-color: var(--bg-card);
    border-radius: 8px;
    overflow: hidden;
}

.findings-table thead {
    background-color: rgba(255,255,255,0.05);
    border-bottom: 2px solid var(--severity-critical);
}

.findings-table th {
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-size: 0.85rem;
}

.findings-table td {
    vertical-align: middle;
    padding: 1rem;
}

.cvss-badge {
    font-family: 'Fira Code', monospace;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-weight: 600;
}

.cvss-critical { background-color: var(--severity-critical); }
.cvss-high { background-color: var(--severity-high); }
.cvss-medium { background-color: var(--severity-medium); }
.cvss-low { background-color: var(--severity-low); }
    </style>
</head>
<body>
    <!-- Overlay for details panel -->
    <div class="overlay" id="detailsOverlay"></div>

    <!-- Details panel (hidden by default) -->
    <div class="details-panel" id="detailsPanel">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 id="detailsTitle">Endpoint Details</h3>
            <button class="btn btn-close btn-close-white" onclick="hideDetails()"></button>
        </div>
        
        <div class="mb-4">
            <h5>Endpoint Information</h5>
            <div class="d-flex align-items-center gap-3 mb-3">
                <span class="method-badge method-GET" id="detailsMethod">GET</span>
                <code id="detailsPath">/api/endpoint</code>
            </div>
            <div class="d-flex align-items-center gap-3">
                <span class="severity-indicator severity-untested" id="detailsSeverity">
                    <i class="severity-icon bi bi-question-circle-fill"></i>
                    <span>UNTESTED</span>
                </span>
                <span class="badge bg-secondary" id="detailsStatus">UNTESTED</span>
            </div>
        </div>

        <div class="mb-4">
            <h5>Last Tested</h5>
            <p id="detailsLastTested">Never tested</p>
        </div>

        <div class="mb-4" id="detailsVulnerabilities">
            <h5>Vulnerabilities</h5>
            <div class="alert alert-info" id="noVulnerabilitiesAlert">
                No vulnerabilities found or endpoint not tested yet.
            </div>
            <div id="vulnerabilitiesList" style="display: none;"></div>
        </div>

        <div class="mb-4">
            <h5>Recommendations</h5>
            <div class="alert alert-secondary" id="detailsRecommendations">
                Test this endpoint to get security recommendations.
            </div>
        </div>

        <button class="btn btn-primary w-100" onclick="testCurrentEndpoint()">
            <i class="bi bi-shield-check me-2"></i>Run Security Test
        </button>
    </div>

    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-md-3">
                <div class="mt-4" id="testResults">
                    <h4><i class="bi bi-clipboard2-check me-2"></i>Test Results</h4>
                    <div class="alert alert-info" id="resultsPlaceholder">
                        Test results will appear here when tests are run.
                    </div>
                    <div id="actualResults" style="display:none;">
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle me-2"></i>
                            Tests completed. View findings in the Security Findings section below.
                        </div>
                    </div>
                </div>
                <div class="test-controls">
                    <h4 class="mb-3"><i class="bi bi-shield-slash me-2"></i>Test Parameters</h4>
                    <form id="testForm" enctype="multipart/form-data">
                        <div class="checkbox-group">
                            <div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="tests" value="owasp" id="testowasp" checked>
                                    <label class="form-check-label" for="testowasp">OWASP TOP 10</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="tests" value="findnew" id="testfindnew">
                                    <label class="form-check-label" for="testfindnew">Finding new endpoints</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="tests" value="sql" id="testSql">
                                    <label class="form-check-label" for="testSql">SQL Injection</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="tests" value="auth" id="testAuth">
                                    <label class="form-check-label" for="testAuth">Broken Authentication</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="tests" value="data" id="testData">
                                    <label class="form-check-label" for="testData">Data Exposure</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="tests" value="rate" id="testRate">
                                    <label class="form-check-label" for="testRate">Rate Limiting</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="tests" value="jwt" id="testJWT">
                                    <label class="form-check-label" for="testJWT">JWT Token</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="tests" value="ssrf" id="testSSRF">
                                    <label class="form-check-label" for="testSSRF">SSRF</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="tests" value="assetmanage" id="testASSETMANAGE">
                                    <label class="form-check-label" for="testASSETMANAGE">Improper asset management</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="tests" value="auth" id="testAuth" checked>
                                    <label class="form-check-label" for="testAuth">Authentication Bypass</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="tests" value="headers" id="testHeaders">
                                    <label class="form-check-label" for="testHeaders">Header Security</label>
                                </div>
                            </div>
                            <div>
                                <h5 class="mt-4"><i class="bi bi-file-arrow-up me-2"></i>Attack Configuration Files</h5>
                                <!-- Brute Force Credentials -->
                                <div class="mb-3">
                                    <label class="form-label">Brute Force Credentials (CSV/TXT)</label>
                                    <input type="file" class="form-control" name="bruteforce_file" accept=".csv,.txt">
                                    <small class="text-muted">Format: username,password (one per line)</small>
                                </div>

                                <!-- Endpoints Wordlist -->
                                <div class="mb-3">
                                    <label class="form-label">Custom Endpoints List (TXT)</label>
                                    <input type="file" class="form-control" name="endpoints_file" accept=".txt">
                                    <small class="text-muted">One endpoint path per line</small>
                                </div>

                                <!-- Injection Payloads -->
                                <div class="mb-3">
                                    <label class="form-label">Injection Payloads (TXT)</label>
                                    <input type="file" class="form-control" name="injection_file" accept=".txt">
                                    <small class="text-muted">SQLi/XSS payloads, one per line</small>
                                </div>

                                <!-- JWT Tokens -->
                                <div class="mb-3">
                                    <label class="form-label">JWT Token List (TXT)</label>
                                    <input type="file" class="form-control" name="jwt_file" accept=".txt">
                                    <small class="text-muted">One JWT token per line</small>
                                </div>
                                
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary w-100 mt-3" onclick="runSelectedTests()">
                            <i class="bi bi-shield-check me-2"></i>Run Security Tests
                        </button>
                    </form>
                </div>
            </div>

            <div class="col-md-9">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="mb-0">API Security Dashboard - {{ spec_name }}</h1>
                    <a href="/" class="btn btn-outline-light">
                        <i class="bi bi-arrow-left-circle me-2"></i>Back to Home
                    </a>
                </div>
                <!-- In the col-md-9 section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card findings-table">
            <div class="card-body">
                <h5 class="card-title mb-3"><i class="bi bi-clipboard2-x me-2"></i>Security Findings</h5>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Method</th>
                                <th>Endpoint</th>
                                <th>Category</th>
                                <th>Test Type</th>
                                <th>CVSS4 Score</th>
                                <th>CVSS Rating</th>
                                <th>Resolution</th>
                            </tr>
                        </thead>
                        <!-- In the findings table -->
<tbody id="findingsBody">
    {% for finding in findings %}
    <tr class="vulnerability-{{ finding.severity|lower }}">
        <td>
            <span class="method-badge method-{{ finding.details.method }}">
                {{ finding.details.method }}
            </span>
        </td>
        <td><code>{{ finding.details.path }}</code></td>
        <td>{{ finding.type }}</td>
        <td>{{ finding.details.test_type }}</td>
        <td>
            <span class="cvss-badge cvss-{{ finding.severity|lower }}">
                {{ finding.details.cvss|float|round(1) }}
            </span>
        </td>
        <td>
            <span class="severity-dot severity-{{ finding.severity|lower }}"></span>
            {{ finding.severity }}
        </td>
        <td>
            <button class="btn btn-sm btn-outline-info" 
                    onclick="showFindingDetails('{{ finding|tojson }}')">
                <i class="bi bi-zoom-in"></i> View
            </button>
        </td>
    </tr>
    {% endfor %}
</tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
                <!-- Vulnerabilities by Severity Card -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-clock-history me-2"></i>Test History</h5>
                        <div id="testHistory" class="list-group list-group-flush">
                        </div>  

                        <h5 class="card-title mb-3">Vulnerabilities by Severity</h5>
                        <div class="d-flex align-items-center mb-3">
                            <span class="me-2 fw-bold">Total:</span>
                            <span class="badge bg-dark rounded-pill">{{ severity_counts.total }}</span>
                        </div>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <span class="severity-dot severity-critical me-2"></span>
                                    Critical
                                </div>
                                <span class="badge" style="background-color: var(--severity-critical);">{{ severity_counts.critical }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <span class="severity-dot severity-high me-2"></span>
                                    High
                                </div>
                                <span class="badge" style="background-color: var(--severity-high);">{{ severity_counts.high }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <span class="severity-dot severity-medium me-2"></span>
                                    Medium
                                </div>
                                <span class="badge" style="background-color: var(--severity-medium);">{{ severity_counts.medium }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <span class="severity-dot severity-low me-2"></span>
                                    Low
                                </div>
                                <span class="badge" style="background-color: var(--severity-low);">{{ severity_counts.low }}</span>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <!-- Severity Legend -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card bg-dark">
                            <div class="card-body py-2">
                                <div class="d-flex flex-wrap gap-3">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-check-circle-fill text-success me-2"></i>
                                        <span>No Issues</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-info-circle-fill text-info me-2"></i>
                                        <span>Low Severity</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
                                        <span>Medium Severity</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-exclamation-octagon-fill text-orange me-2"></i>
                                        <span>High Severity</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-x-octagon-fill text-danger me-2"></i>
                                        <span>Critical Severity</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-question-circle-fill text-secondary me-2"></i>
                                        <span>Not Tested</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                

                <!-- Loading spinner -->
                <div class="loading-spinner" id="loadingSpinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>

                <!-- Endpoints List -->
                <div class="row row-cols-1 row-cols-md-2 g-4" id="endpointsContainer">
                    {% for endpoint in endpoints %}
                    <div class="col">
                        <div class="endpoint-card card h-100 severity-{{ endpoint.severity|default('untested') }}"
                            data-method="{{ endpoint.method }}"
                            data-path="{{ endpoint.path }}"
                            onclick="showEndpointDetails(this)">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <h5 class="card-title mb-0">
                                            <span class="method-badge method-{{ endpoint.method }} me-2">
                                                {{ endpoint.method }}
                                            </span>
                                            {{ endpoint.path }}
                                        </h5>
                                    </div>
                                    <div class="severity-indicator severity-{{ endpoint.severity|default('untested') }}">
                                        <i class="severity-icon bi 
                                            {% if endpoint.severity == 'none' %}bi-check-circle-fill
                                            {% elif endpoint.severity == 'low' %}bi-info-circle-fill
                                            {% elif endpoint.severity == 'medium' %}bi-exclamation-triangle-fill
                                            {% elif endpoint.severity == 'high' %}bi-exclamation-octagon-fill
                                            {% elif endpoint.severity == 'critical' %}bi-x-octagon-fill
                                            {% else %}bi-question-circle-fill{% endif %}"></i>
                                        <span>{{ endpoint.severity|default('untested')|upper }}</span>
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="badge 
                                        {% if endpoint.vulnerability_status == 'confirmed' %}bg-danger
                                        {% elif endpoint.vulnerability_status == 'suspected' %}bg-warning
                                        {% else %}bg-secondary{% endif %}">
                                        {{ endpoint.vulnerability_status|default('untested')|upper }}
                                    </span>
                                    <span class="text-muted small">
                                        <i class="bi bi-clock-history me-1"></i>
                                        {{ endpoint.last_tested|default('Never tested', true) }}
                                    </span>
                                </div>

                                {% if endpoint.issues %}
                                <div class="mb-3">
                                    <h6 class="mb-2">Identified Issues:</h6>
                                    <ul class="list-group list-group-flush">
                                        {% for issue in endpoint.issues %}
                                        <li class="list-group-item bg-transparent text-white border-secondary">
                                            <i class="bi 
                                                {% if issue.severity == 'critical' %}bi-x-octagon-fill text-danger
                                                {% elif issue.severity == 'high' %}bi-exclamation-octagon-fill text-orange
                                                {% elif issue.severity == 'medium' %}bi-exclamation-triangle-fill text-warning
                                                {% else %}bi-info-circle-fill text-info{% endif %} me-2"></i>
                                            {{ issue.description }}
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% endif %}

                                <div class="d-flex justify-content-end">
                                    <button class="btn btn-sm btn-outline-light me-2" 
                                            onclick="testSingleEndpoint(event, this)"
                                            data-bs-toggle="tooltip" 
                                            title="Test this endpoint">
                                        <i class="bi bi-bug"></i> Test
                                    </button>
                                    <button class="btn btn-sm btn-outline-info"
                                            onclick="showEndpointDetails(event, this)"
                                            data-bs-toggle="tooltip"
                                            title="View details">
                                        <i class="bi bi-zoom-in"></i> Details
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
            </div>
            
        </div>
        
    </div>
    

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Current endpoint being viewed in details panel
        let currentEndpointCard = null;

        async function runSelectedTests() {
            const btn = document.querySelector('#testForm button');
            try {
                const form = document.getElementById('testForm');
                const formData = new FormData(form);

                // Get spec_id from localStorage
                const specId = localStorage.getItem('selectedSpecFile');
                if (!specId) throw new Error('Specification ID missing from localStorage');

                // Append it to the FormData
                formData.append('spec_id', specId);

                btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Running...';
                btn.disabled = true;
                const runTestsUrl = "{{ url_for('run_tests') }}";
                const response = await fetch(runTestsUrl, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || 'Test failed');
                }

                const data = await response.json();
                displayTestResults(data);
            } catch (error) {
                showError(error.message);
            } finally {
                btn.innerHTML = '<i class="bi bi-shield-check me-2"></i>Run Security Tests';
                btn.disabled = false;
            }
        }
function showError(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-danger mt-3';
    alert.innerHTML = `
        <i class="bi bi-x-circle-fill me-2"></i>
        ${message}
    `;
    document.querySelector('.test-controls').appendChild(alert);
    setTimeout(() => alert.remove(), 5000);
}

        // Replace the displayTestResults function with:
async function displayTestResults(data) {
    // Update real-time results
    const resultsDiv = document.getElementById('actualResults');
    resultsDiv.innerHTML = `
        <div class="alert alert-${data.stats.critical > 0 ? 'danger' : 'success'}">
            <i class="bi ${data.stats.critical > 0 ? 'bi-shield-slash' : 'bi-shield-check'} me-2"></i>
            ${data.findings.length} findings - 
            ${data.stats.critical} Critical, 
            ${data.stats.high} High,
            ${data.stats.medium} Medium,
            ${data.stats.low} Low
        </div>
    `;
    resultsDiv.style.display = 'block';

    // Update findings table
    const findingsBody = document.getElementById('findingsBody');
    findingsBody.innerHTML = data.findings.map(finding => `
        <tr>
            <td><span class="method-badge method-${finding.details.method}">${finding.details.method}</span></td>
            <td><code>${finding.details.path}</code></td>
            <td>${finding.type}</td>
            <td>${finding.details.test_type || 'Generic'}</td>
            <td>${(finding.details.cvss || 0).toFixed(1)}</td>
            <td><span class="cvss-badge cvss-${getSeverityLevel(finding.details.cvss)}">${getSeverityLevel(finding.details.cvss)}</span></td>
            <td><span class="badge bg-${finding.resolved ? 'success' : 'danger'}">${finding.resolved ? 'Resolved' : 'Pending'}</span></td>
        </tr>
    `).join('');

    // Update severity chart
    updateSeverityChart(data.stats);
}
// Add this to your JavaScript
async function refreshDashboard() {
    try {
        const response = await fetch('/dashboard-data');
        if (!response.ok) throw new Error('Network response was not ok');
        
        const data = await response.json();
        if (!Array.isArray(data)) throw new Error('Invalid data format');

        updateTestHistory(data);
    } catch (error) {
        console.error('Dashboard refresh failed:', error);
        showError('Failed to load test history');
    }
}
function updateTestHistory(data) {
    const historyContainer = document.getElementById('testHistory');
    if (!historyContainer) return;

    historyContainer.innerHTML = data.map(run => `
        <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h6 class="mb-1">${new Date(run.timestamp).toLocaleString()}</h6>
                    <small class="text-muted">Spec ID: ${run.spec_id}</small>
                </div>
                <div class="text-end">
                    <div class="badge bg-danger">${run.stats.critical} Critical</div>
                    <div class="badge bg-warning">${run.stats.high} High</div>
                    <div class="badge bg-info">${run.stats.medium} Medium</div>
                    <div class="badge bg-success">${run.stats.low} Low</div>
                </div>
            </div>
        </div>
    `).join('');
}

document.addEventListener('DOMContentLoaded', () => {
    refreshDashboard();
    setInterval(refreshDashboard, 30000);  // Refresh every 30 seconds
});
function getSeverityLevel(cvss) {
    if (cvss >= 9) return 'critical';
    if (cvss >= 7) return 'high';
    if (cvss >= 4) return 'medium';
    return 'low';
}

function updateSeverityChart(stats) {
    document.querySelectorAll('.severity-count').forEach(el => {
        const severity = el.dataset.severity;
        el.textContent = stats[severity];
        el.style.backgroundColor = `var(--severity-${severity})`;
    });
}

        function testSingleEndpoint(event, button) {
            event.stopPropagation(); // Prevent card click event
            const card = button.closest('.endpoint-card');
            currentEndpointCard = card;
            
            // Show loading state on the button
            const originalContent = button.innerHTML;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Testing...';
            button.disabled = true;

            // Get endpoint details
            const method = card.dataset.method;
            const path = card.dataset.path;
            
            // Show loading spinner
            document.getElementById('loadingSpinner').style.display = 'block';
            
            // Simulate API call (replace with actual API call)
            setTimeout(() => {
                // Hide loading spinner
                document.getElementById('loadingSpinner').style.display = 'none';
                
                // This would be replaced with actual API response handling
                const severityLevels = ['none', 'low', 'medium', 'high', 'critical'];
                const randomSeverity = severityLevels[Math.floor(Math.random() * severityLevels.length)];
                
                // Generate some random vulnerabilities
                const vulnerabilities = [];
                if (randomSeverity !== 'none') {
                    const vulnTypes = [
                        {name: 'SQL Injection', severity: 'high'},
                        {name: 'XSS', severity: 'medium'},
                        {name: 'Broken Authentication', severity: 'critical'},
                        {name: 'Sensitive Data Exposure', severity: 'high'},
                        {name: 'CSRF', severity: 'medium'},
                        {name: 'Insecure Direct Object Reference', severity: 'medium'},
                        {name: 'Security Misconfiguration', severity: 'low'}
                    ];
                    
                    const numVulnerabilities = randomSeverity === 'critical' ? 3 : 
                                              randomSeverity === 'high' ? 2 : 
                                              randomSeverity === 'medium' ? 1 : 0;
                    
                    for (let i = 0; i < numVulnerabilities; i++) {
                        const randomVuln = vulnTypes[Math.floor(Math.random() * vulnTypes.length)];
                        vulnerabilities.push({
                            description: randomVuln.name,
                            severity: randomVuln.severity,
                            recommendation: getRecommendationForVulnerability(randomVuln.name)
                        });
                    }
                }
                
                // Update the endpoint card
                updateEndpointCard(card, randomSeverity, vulnerabilities);
                
                // Restore button
                button.innerHTML = originalContent;
                button.disabled = false;
                
                // Show toast notification
                showTestResultToast(method, path, randomSeverity);
                
                // If details panel is open for this endpoint, update it
                if (document.getElementById('detailsPanel').classList.contains('show')){
                    showEndpointDetails(null, card);
                }
            }, 1500);
        }

        function updateEndpointCard(card, severity, vulnerabilities) {
            // Update the card appearance
            card.className = card.className.replace(/\bseverity-\S+/g, '');
            card.classList.add(`severity-${severity}`);
            
            // Update the severity indicator
            const severityIndicator = card.querySelector('.severity-indicator');
            severityIndicator.className = severityIndicator.className.replace(/\bseverity-\S+/g, '');
            severityIndicator.classList.add(`severity-${severity}`);
            
            // Update the icon
            const icon = severityIndicator.querySelector('.bi');
            icon.className = 'severity-icon bi ' + 
                (severity === 'none' ? 'bi-check-circle-fill' :
                 severity === 'low' ? 'bi-info-circle-fill' :
                 severity === 'medium' ? 'bi-exclamation-triangle-fill' :
                 severity === 'high' ? 'bi-exclamation-octagon-fill' :
                 'bi-x-octagon-fill');
            
            // Update the text
            severityIndicator.querySelector('span').textContent = severity.toUpperCase();
            
            // Update vulnerability status
            const statusBadge = card.querySelector('.badge');
            statusBadge.className = 'badge ' + 
                (severity === 'critical' || severity === 'high' ? 'bg-danger' :
                 severity === 'medium' ? 'bg-warning' :
                 severity === 'low' ? 'bg-info' :
                 severity === 'none' ? 'bg-success' : 'bg-secondary');
            statusBadge.textContent = severity === 'none' ? 'SECURE' : 'VULNERABLE';
            
            // Update last tested time
            const lastTested = card.querySelector('.text-muted.small');
            const now = new Date();
            lastTested.innerHTML = `<i class="bi bi-clock-history me-1"></i>${now.toLocaleString()}`;
            
            // Update vulnerabilities list
            const issuesContainer = card.querySelector('.mb-3');
            if (issuesContainer) {
                if (vulnerabilities.length > 0) {
                    let issuesHTML = '<h6 class="mb-2">Identified Issues:</h6><ul class="list-group list-group-flush">';
                    vulnerabilities.forEach(vuln => {
                        issuesHTML += `
                            <li class="list-group-item bg-transparent text-white border-secondary">
                                <i class="bi ${getSeverityIconClass(vuln.severity)} me-2"></i>
                                ${vuln.description}
                            </li>
                        `;
                    });
                    issuesHTML += '</ul>';
                    issuesContainer.innerHTML = issuesHTML;
                } else if (severity === 'none') {
                    issuesContainer.innerHTML = '<div class="alert alert-success mb-0">No vulnerabilities found</div>';
                }
            }
        }

        function getSeverityIconClass(severity) {
            return severity === 'critical' ? 'bi-x-octagon-fill text-danger' :
                   severity === 'high' ? 'bi-exclamation-octagon-fill text-orange' :
                   severity === 'medium' ? 'bi-exclamation-triangle-fill text-warning' :
                   'bi-info-circle-fill text-info';
        }

        function getRecommendationForVulnerability(vulnType) {
            const recommendations = {
                'SQL Injection': 'Use parameterized queries or prepared statements. Implement input validation and consider using an ORM.',
                'XSS': 'Implement proper output encoding. Use Content Security Policy (CSP) headers. Sanitize all user inputs.',
                'Broken Authentication': 'Implement multi-factor authentication. Enforce strong password policies. Use secure session management.',
                'Sensitive Data Exposure': 'Encrypt sensitive data at rest and in transit. Disable caching for sensitive responses. Use proper key management.',
                'CSRF': 'Implement anti-CSRF tokens. Ensure SameSite cookie attributes are set. Validate the Origin header.',
                'Insecure Direct Object Reference': 'Implement access control checks. Use indirect reference maps. Avoid exposing internal object references.',
                'Security Misconfiguration': 'Harden server configuration. Disable unnecessary features. Keep software updated and patched.'
            };
            return recommendations[vulnType] || 'Review security best practices for this type of endpoint.';
        }

        function showTestResultToast(method, path, severity) {
            const toast = document.createElement('div');
            toast.className = `toast show position-fixed bottom-0 end-0 m-3 bg-${
                severity === 'critical' ? 'danger' : 
                severity === 'high' ? 'warning' : 
                severity === 'medium' ? 'info' : 'success'
            }`;
            toast.style.zIndex = '1100';
            toast.innerHTML = `
                <div class="toast-header">
                    <strong class="me-auto">Test Completed</strong>
                    <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
                <div class="toast-body">
                    <strong>${method} ${path}</strong><br>
                    Status: ${severity.toUpperCase()}
                </div>
            `;
            document.body.appendChild(toast);
            
            // Auto-remove toast after 5 seconds
            setTimeout(() => toast.remove(), 5000);
        }

        function showEndpointDetails(event, element) {
            if (event) {
                event.stopPropagation(); // Prevent card click event if called from button
            }
            
            const card = element ? element.closest('.endpoint-card') : element;
            currentEndpointCard = card;
            
            const method = card.dataset.method;
            const path = card.dataset.path;
            const severity = card.className.match(/severity-(\w+)/)[1];
            const statusBadge = card.querySelector('.badge');
            const lastTested = card.querySelector('.text-muted.small');
            const issues = [];
            
            // Collect vulnerabilities if they exist
            const issuesList = card.querySelectorAll('.list-group-item');
            issuesList.forEach(item => {
                const iconClass = item.querySelector('i').className;
                const severity = iconClass.includes('danger') ? 'critical' :
                                iconClass.includes('orange') ? 'high' :
                                iconClass.includes('warning') ? 'medium' : 'low';
                issues.push({
                    description: item.textContent.trim(),
                    severity: severity,
                    recommendation: getRecommendationForVulnerability(item.textContent.trim().split(' - ')[0])
                });
            });
            
            // Update details panel
            document.getElementById('detailsMethod').className = `method-badge method-${method}`;
            document.getElementById('detailsMethod').textContent = method;
            document.getElementById('detailsPath').textContent = path;
            
            const severityIndicator = document.getElementById('detailsSeverity');
            severityIndicator.className = `severity-indicator severity-${severity}`;
            severityIndicator.querySelector('i').className = `severity-icon bi ${
                severity === 'none' ? 'bi-check-circle-fill' :
                severity === 'low' ? 'bi-info-circle-fill' :
                severity === 'medium' ? 'bi-exclamation-triangle-fill' :
                severity === 'high' ? 'bi-exclamation-octagon-fill' :
                'bi-x-octagon-fill'
            }`;
            severityIndicator.querySelector('span').textContent = severity.toUpperCase();
            
            document.getElementById('detailsStatus').className = `badge ${
                severity === 'critical' || severity === 'high' ? 'bg-danger' :
                severity === 'medium' ? 'bg-warning' :
                severity === 'low' ? 'bg-info' :
                severity === 'none' ? 'bg-success' : 'bg-secondary'
            }`;
            document.getElementById('detailsStatus').textContent = severity === 'none' ? 'SECURE' : 
                                                                severity === 'untested' ? 'UNTESTED' : 'VULNERABLE';
            
            document.getElementById('detailsLastTested').textContent = lastTested ? 
                lastTested.textContent.replace('Never tested', 'Never tested') : 'Never tested';
            
            // Update vulnerabilities list
            const vulnerabilitiesList = document.getElementById('vulnerabilitiesList');
            const noVulnerabilitiesAlert = document.getElementById('noVulnerabilitiesAlert');
            
            if (issues.length > 0) {
                noVulnerabilitiesAlert.style.display = 'none';
                vulnerabilitiesList.style.display = 'block';
                vulnerabilitiesList.innerHTML = '';
                
                issues.forEach(issue => {
                    const item = document.createElement('div');
                    item.className = `vulnerability-item vulnerability-${issue.severity}`;
                    item.innerHTML = `
                        <div class="d-flex justify-content-between">
                            <strong>${issue.description}</strong>
                            <span class="badge ${
                                issue.severity === 'critical' ? 'bg-danger' :
                                issue.severity === 'high' ? 'bg-warning' :
                                issue.severity === 'medium' ? 'bg-info' : 'bg-secondary'
                            }">${issue.severity.toUpperCase()}</span>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">Recommendation:</small>
                            <p class="mb-0">${issue.recommendation}</p>
                        </div>
                    `;
                    vulnerabilitiesList.appendChild(item);
                });
            } else {
                noVulnerabilitiesAlert.style.display = 'block';
                vulnerabilitiesList.style.display = 'none';
                noVulnerabilitiesAlert.className = `alert ${
                    severity === 'none' ? 'alert-success' : 'alert-info'
                }`;
                noVulnerabilitiesAlert.textContent = severity === 'none' ? 
                    'No vulnerabilities found in this endpoint.' : 
                    'No vulnerabilities found or endpoint not tested yet.';
            }
            
            // Update recommendations
            const recommendationsElement = document.getElementById('detailsRecommendations');
            if (severity === 'none') {
                recommendationsElement.className = 'alert alert-success';
                recommendationsElement.innerHTML = `
                    <i class="bi bi-check-circle-fill me-2"></i>
                    This endpoint appears to be secure. Continue to monitor for new vulnerabilities.
                `;
            } else if (severity === 'untested') {
                recommendationsElement.className = 'alert alert-secondary';
                recommendationsElement.innerHTML = `
                    <i class="bi bi-question-circle-fill me-2"></i>
                    Test this endpoint to get security recommendations.
                `;
            } else {
                recommendationsElement.className = 'alert alert-warning';
                let recommendationsHTML = '<i class="bi bi-exclamation-triangle-fill me-2"></i>';
                if (issues.length > 0) {
                    recommendationsHTML += '<strong>Recommended actions:</strong><ul class="mt-2 mb-0">';
                    issues.forEach(issue => {
                        recommendationsHTML += `<li>${issue.recommendation}</li>`;
                    });
                    recommendationsHTML += '</ul>';
                } else {
                    recommendationsHTML += 'Review this endpoint for potential security issues.';
                }
                recommendationsElement.innerHTML = recommendationsHTML;
            }
            
            // Show the details panel
            document.getElementById('detailsOverlay').style.display = 'block';
            document.getElementById('detailsPanel').classList.add('show');
        }

        function hideDetails() {
            document.getElementById('detailsOverlay').style.display = 'none';
            document.getElementById('detailsPanel').classList.remove('show');
        }
        
        function testCurrentEndpoint() {
            if (currentEndpointCard) {
                const testButton = currentEndpointCard.querySelector('.btn-outline-light');
                if (testButton) {
                    testSingleEndpoint(null, testButton);
                }
            }
        }

        // Close details panel when clicking overlay
        document.getElementById('detailsOverlay').addEventListener('click', hideDetails);

        // Make entire cards clickable to show details
        document.querySelectorAll('.endpoint-card').forEach(card => {
            card.addEventListener('click', function() {
                showEndpointDetails(null, this);
            });
        });
        function showFindingDetails(finding) {
    const detailsPanel = document.getElementById('detailsPanel');
    const parsedFinding = JSON.parse(finding);
    
    // Update panel content
    detailsPanel.querySelector('#detailsTitle').textContent = parsedFinding.type;
    detailsPanel.querySelector('#detailsSeverity').textContent = parsedFinding.severity;
    
    const content = `
        <h5>Description</h5>
        <p>${parsedFinding.message}</p>
        
        ${parsedFinding.details.cves ? `
            <h5 class="mt-4">Associated CVEs</h5>
            <ul>
                ${parsedFinding.details.cves.map(cve => `
                    <li>${cve.id} (CVSS: ${cve.cvss}) - ${cve.description}</li>
                `).join('')}
            </ul>
        ` : ''}
        
        <h5 class="mt-4">Recommendation</h5>
        <div class="alert alert-info">
            ${this.getHeaderRecommendation(parsedFinding.type)}
        </div>
    `;
    
    detailsPanel.querySelector('#detailsContent').innerHTML = content;
    detailsPanel.classList.add('show');
}

function getHeaderRecommendation(type) {
    const recommendations = {
        'Missing Security Headers': 'Implement missing security headers according to OWASP guidelines',
        'CORS Misconfiguration': 'Restrict CORS origins and disable credentials for wildcard origins',
        'Server Information': 'Remove or obfuscate server version information',
        'Vulnerable Server': 'Update server software to latest patched version',
        'Header Manipulation': 'Validate and sanitize all incoming headers'
    };
    return recommendations[type] || 'Review security headers configuration';
}
    </script>
</body>
</html>