<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>APISploit Pro</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="../static/bootstrap.min.css" />
  <link rel="stylesheet" href="../static/styles.css" />
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
</head>
<body>
  <header class="header">
    <div class="container text-center">
      <h1 class="display-4 fw-bold mb-3">
        <span class="gradient-text">APISploit Pro</span>
      </h1>
      <p class="lead opacity-75">Advanced API Security Testing Platform</p>
      
      <div class="d-flex justify-content-between align-items-center mb-4 gap-3 flex-wrap">
        <div class="d-flex align-items-center gap-3">
          <div class="dropdown position-static">
            <button class="btn btn-dark dropdown-toggle" 
                  type="button" 
                  id="filesDropdown" 
                  data-bs-toggle="dropdown" 
                  aria-expanded="false">
              <i class="bi bi-files me-2"></i>
              <span id="selectedFileName">{{ filename if filename else 'New Scan' }}</span>
          </button>
            <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="filesDropdown">
              {% for name in uploaded_specs.keys() %}
                <li>
                  <a class="dropdown-item d-flex justify-content-between align-items-center" href="{{ url_for('show_requests', unique_id=name) }}">
                    <div class="fw-bold">{{ uploaded_specs[name]['original_filename'] }}</div>
                  </a>
                </li>
              {% else %}
                <li><span class="dropdown-item text-muted">No specifications found</span></li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container py-5">
    <div class="upload-section">
      <div class="card">
        <div class="card-header bg-transparent border-bottom">
          <h4 class="mb-0"><i class="bi bi-cloud-upload me-2"></i>API Configuration</h4>
        </div>
        <div class="card-body">
          <form id="apiConfigForm" action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data">
            <div class="mb-4">
              <label class="form-label">Base URL <span class="text-danger">*</span></label>
              <div class="input-group">
                <input type="url" class="form-control" id="base_url" name="base_url" 
                       placeholder="https://api.example.com" required>
                <button class="btn btn-outline-secondary" type="button" id="checkUrlBtn">
                  <i class="bi bi-link-45deg"></i> Check
                </button>
              </div>
              <div id="urlStatus" class="mt-2 small"></div>
            </div>
            
            <div class="mb-4">
              <label class="form-label">API Specification (Optional)</label>
              <input type="file" class="form-control" id="file" name="file" 
                     accept=".json,.yaml,.yml,.har">
              <div class="form-text">Upload OpenAPI/Swagger, Postman, or HAR file</div>
            </div>
            
            <div class="mb-4">
              <label class="form-label">Application Name <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="app_name" name="app_name" 
                     placeholder="My API Application" required>
            </div>
            
            <div class="alert alert-info">
              <i class="bi bi-info-circle"></i> If no specification is provided, APISploit will attempt to discover endpoints automatically.
            </div>
            
            <button type="submit" class="btn btn-primary w-100 py-2">
              <i class="bi bi-shield-check me-2"></i>Begin Security Audit
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOMContentLoaded triggered');
  
      const fileNameElement = document.getElementById('selectedFileName');
      const specInput = document.getElementById('file');
  
      // Initialization
      const storedDropdownFile = localStorage.getItem('selectedSpecFile');
      const storedUploadFile   = localStorage.getItem('uploadedSpecFile');
      const serverFile         = "{{ filename|default('New Scan', true) }}";
      const initialDisplay = storedUploadFile || storedDropdownFile || serverFile;
      if (fileNameElement) fileNameElement.textContent = initialDisplay;
      console.log('Initial display set to:', initialDisplay);
  
      // Dropdown selection persistence
      const dropdownLinks = document.querySelectorAll('.dropdown-item[href]');
      console.log('Dropdown links count:', dropdownLinks.length);
      dropdownLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const fileNameElem = this.querySelector('.fw-bold');
          const fileName = fileNameElem ? fileNameElem.textContent.trim() : null;
          console.log('Clicked dropdown link text:', fileName);
          if (fileName) {
            localStorage.setItem('selectedSpecFile', fileName);
            console.log('selectedSpecFile saved:', localStorage.getItem('selectedSpecFile'));
            if (fileNameElement) fileNameElement.textContent = fileName;
          }
          // Navigate after short delay
          setTimeout(() => window.location.href = this.href, 100);
        });
      });
  
      // File upload persistence
      if (specInput) {
        specInput.addEventListener('change', function() {
          const file = this.files[0];
          console.log('File selected:', file);
          if (!file) return;
          localStorage.setItem('uploadedSpecFile', file.name);
          if (fileNameElement) fileNameElement.textContent = file.name;
        });
      }
  
      // URL validation logic (unchanged)
      const urlCheckBtn = document.getElementById('checkUrlBtn');
      const baseUrlField = document.getElementById('base_url');
      const urlStatus = document.getElementById('urlStatus');
      if (urlCheckBtn && baseUrlField && urlStatus) {
        urlCheckBtn.addEventListener('click', async () => {
          const url = baseUrlField.value.trim();
          if (!url) return showStatus('Please enter a URL first', 'danger');
          try { new URL(url); } catch { return showStatus('Invalid URL format', 'danger'); }
          showStatus('Checking URL reachability...', 'info');
          urlCheckBtn.disabled = true;
          urlCheckBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Checking';
          try {
            const response = await fetch(`/check-url?url=${encodeURIComponent(url)}`);
            const data = await response.json();
            if (response.ok && data.status >= 200 && data.status < 400) {
              showStatus(`Reachable (${data.status})`, 'success');
            } else {
              showStatus(data.error || `Server responded with ${data.status}`, 'warning');
            }
          } catch (error) {
            console.error('URL Check Error:', error);
            showStatus('Connection failed', 'danger');
          } finally {
            urlCheckBtn.disabled = false;
            urlCheckBtn.innerHTML = '<i class="bi bi-link-45deg"></i> Check';
          }
        });
      }
  
      function showStatus(message, type) {
        const icons = { success: 'check-circle', danger: 'exclamation-triangle', warning: 'exclamation-circle', info: 'info-circle' };
        urlStatus.innerHTML = `<span class="text-${type}"><i class="bi bi-${icons[type]} me-2"></i> ${message}</span>`;
      }
    });
  </script>
  
  
  
</body>
</html>